<div style="margin: 0px 60px;">

<% content_for :title do -%>
Reservar Consolas <i class="fa fa-caret-down"></i>
<% end -%>

<% content_for :menus do -%>
<li><h5 class="drop-title"><%= link_to "Consolas", consoles_path %></h5></li>
<li><h5 class="drop-title"><%= link_to "Precio de reserva", reserve_prices_path %></h5></li>
<% end -%>

<% content_for :button do -%>
<%= link_to new_reservation_path, remote: true, class: 'btn btn-success bold registrar' do %>
<div><i class="fa fa-plus"></i>
&nbsp;Registrar Reserva</div>
<% end %>
<% end -%>

<div class="panel panel-default" id="Reserve_Page">
  <div class="panel-body table">
    <table id="datatable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Consola</th>
          <th>Fecha</th>
          <th>Hora inicio</th>
          <th>Hora fin</th>
          <th>Precio</th>
          <th>Estado</th>
          <th width="170px">Acciones</th>
        </tr>
      </thead>

      <tbody id="reservations">
         <%= render @reservations %>
      </tbody>
    </table>
  </div>
</div>
<br>
<%= render 'dialog' %>
</div>
<script type="text/javascript">
    var res;
    var current_time = new Date;
    if (gon.reserve_id != null) {
      var minutes_hour = current_time.getHours() * 60;
      var minutes = current_time.getMinutes();
      var sum_hour = minutes_hour + minutes;
      var subtraction = sum_hour - gon.hour_start;
      if (subtraction <= 5) {

        $.confirm({
          confirmButton: 'Sí',
          cancelButton: 'No',
          title: 'Inicio Reserva',
          content: '¿El  cliente está listo para iniciar la reserva?',

          confirm: function(){
            //Cambiar a estado "enProceso"
              $.alert('¡La reserva ha iniciado!');
              res = 1;
              miajax(res, gon.reserve_id);
          },
          cancel: function(){
            $.confirm({
              confirmButton: 'Posponer',
              cancelButton: 'Cancelar',
              title: 'Confirmación inicio de reserva',
              content: '¿Qué desea?',
              confirm: function(){
                //Redireccionar a editar la reserva
                  res = 2;
              },
              cancel: function(){
                //Cambiar el estado a "cancelada"
                  $.alert('¡La reserva se ha cancelado!');
                  res = 3;
                  miajax(res, gon.reserve_id);
              }
            });
          }
        });

      }else {
        res = 0;
        miajax(res, gon.reserve_id);
      }

      function miajax(resp, id){
        respuesta = resp;
        identify = id;
        $.ajax({
          url:'/reservations/change_state',
          data:{respuesta: respuesta, id: identify},
          type: 'get'

        }).done(function(done){
          location.reload();
        }).error(function(error){
          console.log('Ha ocurrido un error '+ error);
        });

      }
    }
</script>
