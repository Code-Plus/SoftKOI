<div style="margin: 0px 60px;">

<% content_for :title do -%>
Reservar Consolas <i class="fa fa-caret-down"></i>
<% end -%>

<% content_for :menus do -%>
<li><h5 class="drop-title"><%= link_to "Consolas", consoles_path %></h5></li>
<li><h5 class="drop-title"><%= link_to "Precio de reserva", reserve_prices_path %></h5></li>
<% end -%>

<% content_for :button do -%>
<%= link_to new_reservation_path, remote: true, class: 'btn btn-success bold registrar' do %>
<div><i class="fa fa-plus"></i>
&nbsp;Registrar Reserva</div>
<% end %>
<% end -%>

<div class="panel panel-default" id="Reserve_Page">
  <div class="panel-body table">
    <table id="datatable" class="table table-bordered table-striped">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Consola</th>
          <th>Fecha</th>
          <th>Hora inicio</th>
          <th>Hora fin</th>
          <th>Precio</th>
          <th>Estado</th>
          <th width="170px">Acciones</th>
        </tr>
      </thead>

      <tbody id="reservations">
         <%= render @reservations %>
      </tbody>
    </table>
  </div>
</div>
<br>
<%= render 'dialog' %>
</div>

<script type="text/javascript">
  var modaltt;
        setInterval(function(){
          modaltt = $('#new_reservation').length;
          modalrr = $('.edit_reservation').length;
          alerttt = $('.jconfirm-box').length;
          if(modaltt > 0){
            console.log('no recargar la pagina'+ modaltt);
            $('#closemodal').click(function(){
                $('#new_reservation').remove();
                console.log('haz cerrado la modal'+ modaltt);
            });
          }else{
            if(alerttt > 0){
              console.log('No recargar pagina, Se ha inciado una alerta ' + alerttt);
            }else{
              var indexss = $('.paginate_button.active > a').text();
              if (indexss == "1") {
                if(modalrr > 0){
                  console.log("No recargar la pagina porque esta abierta la modal de editar.");
                  $('#closemodal').click(function(){
                      $('.new_reservation').remove();
                      console.log('haz cerrado la modal'+ modalrr);
                  });
                }else{
                  console.log("Recargar pagina la tabla esta en la pagina #"+ indexss);
                    //location.reload();
                }
              }else{
                console.log("No recargar la pagina porque no esta en la pagina # 1 de la tabla al contrario te encuentras en la pagina #"+ indexss);
              }

            }
          }
        },3000);



    var res;
    var current_time = new Date;
    if (gon.reserve_id != null) {
      var minutes_hour = current_time.getHours() * 60;
      var minutes = current_time.getMinutes();
      var sum_hour = minutes_hour + minutes;
      var subtraction = sum_hour - gon.hour_start;
      if (subtraction <= 5) {

        $.confirm({
          confirmButton: 'Sí',
          cancelButton: 'No',
          title: 'Inicio Reserva',
          content: '¿El  cliente está listo para iniciar la reserva?',

          confirm: function(){
            //Cambiar a estado "enProceso"
              $.alert('¡La reserva ha iniciado!');
              res = 1;
              miajax(res, gon.reserve_id);
          },
          cancel: function(){
            $.confirm({
              confirmButton: 'Posponer',
              cancelButton: 'Cancelar',
              title: 'Confirmación inicio de reserva',
              content: '¿Qué desea?',
              confirm: function(){
                //Redireccionar a editar la reserva
                  res = 2;
                  miajax(res, gon.reserve_id);
                  $.ajax({
                    url:'/reservations/'+gon.reserve_id+'/edit'
                  }).error(function(error){
                    console.log('El cliente no ha asistido a la reserva y se ha intentado posponer pero hubo un error en la respuesta del servidor.');
                  });
              },
              cancel: function(){
                //Cambiar el estado a "cancelada"
                  $.alert('¡La reserva se ha cancelado!');
                  res = 3;
                  miajax(res, gon.reserve_id);
              }
            });
          }
        });

      }else {
        res = 0;
        miajax(res, gon.reserve_id);
      }

    function miajax(resp, id){
        respuesta = resp;
        identify = id;
        $.ajax({
          url:'/reservations/change_state',
          data:{respuesta: respuesta, id: identify},
          type: 'get'

        }).done(function(done){
          // if (respuesta == 1 || respuesta == 3) {
          //   location.reload();
          // }
        }).error(function(error){
          console.log('Ha ocurrido un error '+ error);
        });

      }
    }

</script>
